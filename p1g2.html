<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GTuner</title>
    <style>
        .needle {
            width: 2px;
            height: 80px;
            background-color: red;
            position: absolute;
            transform-origin: 50% 100%;
        }
    </style>
</head>
<body>
    <h1>GTuner4</h1>
    <p>GTuner will start automatically when the page loads.</p>
    <div id="pitchDisplay"></div>
    <div class="needle"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Tone.js/14.8.0/Tone.js"></script>
    <script>
        const audioContext = new AudioContext();
        let isTuning = true; // Start automatically
        const referenceTones = {
            E2: 82.41,
            A2: 110.00,
            D3: 146.83,
            G3: 196.00,
            B3: 246.94,
            highE4: 329.63
        };

        const pitchDisplay = document.getElementById('pitchDisplay');
        const needle = document.querySelector('.needle');

        // Create a new microphone source
        const mic = new Tone.UserMedia();

        // Create a new pitch detector
        const pitch = new Tone.FrequencyAnalyzer();

        // Connect the microphone source to the pitch detector
        mic.connect(pitch);

        // Open the microphone and start listening
        mic.open().then(() => {
            // Automatically start the tuner when the microphone is available
            if (isTuning) {
                pitch.on("frequency", (frequency) => {
                    const note = Tone.Frequency(frequency, "Hz").toNote();
                    pitchDisplay.textContent = `Detected Pitch: ${note}`;
                    const targetFrequency = referenceTones[note];
                    const pitchDifference = frequency - targetFrequency;
                    const maxDifference = 10;
                    const rotation = Math.min(Math.max(pitchDifference / maxDifference, -1), 1) * 45;
                    needle.style.transform = `rotate(${rotation}deg)`;
                });
            }
        });
    </script>
</body>
</html>
