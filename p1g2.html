<!DOCTYPE html>
<html>
<head>
<script>
var correlation_worker = new Worker(URL.createObjectURL(new Blob([document.querySelector('script[type="correlation-worker"]').textContent], { type: 'application/javascript' }));

correlation_worker.addEventListener("message", interpret_correlation_result);

function interpret_correlation_result(event) {
    var timeseries = event.data.timeseries;
    var frequency_amplitudes = event.data.frequency_amplitudes;

    var magnitudes = frequency_amplitudes.map(function(z) { return z[0] * z[0] + z[1] * z[1]; });

    var maximum_index = -1;
    var maximum_magnitude = 0;
    for (var i = 0; i < magnitudes.length; i++) {
        if (magnitudes[i] <= maximum_magnitude) continue;

        maximum_index = i;
        maximum_magnitude = magnitudes[i];
    }

    var average = magnitudes.reduce(function(a, b) { return a + b; }, 0) / magnitudes.length;
    var confidence = maximum_magnitude / average;
    var confidence_threshold = 10;

    if (confidence > confidence_threshold) {
        var dominant_frequency = test_frequencies[maximum_index];
        document.getElementById("note-name").textContent = dominant_frequency.name;
        document.getElementById("frequency").textContent = dominant_frequency.frequency;
    }
}
</script>
</head>

<body>
<p>It sounds like you're playing...</p>
<h1 id="note-name"></h1>
<p>
    <span>frequency (Hz):</span>
    <span id="frequency"></span>
</p>
<hr>
<button id="play-note">start/stop an E note</button>
<hr>
<a href="https://github.com/jbergknoff/guitar-tuner">Source code</a> / <a href="http://jonathan.bergknoff.com/journal/making-a-guitar-tuner-html5">Explanatory article</a>

<script type="correlation-worker">
self.onmessage = function(event) {
    var timeseries = event.data.timeseries;
    var test_frequencies = event.data.test_frequencies;
    var sample_rate = event.data.sample_rate;
    var amplitudes = compute_correlations(timeseries, test_frequencies, sample_rate);
    self.postMessage({ "timeseries": timeseries, "frequency_amplitudes": amplitudes });
};

function compute_correlations(timeseries, test_frequencies, sample_rate) {
    var scale_factor = 2 * Math.PI / sample_rate;
    var amplitudes = test_frequencies.map(function(f) {
        var frequency = f.frequency;
        var accumulator = [0, 0];
        for (var t = 0; t < timeseries.length; t++) {
            accumulator[0] += timeseries[t] * Math.cos(scale_factor * frequency * t);
            accumulator[1] += timeseries[t] * Math.sin(scale_factor * frequency * t);
        }
        return accumulator;
    });
    return amplitudes;
}
</script>

<script>
// Request microphone access when the page loads.
navigator.mediaDevices.getUserMedia({ audio: true })
    .then(function(stream) {
        initialize(stream);
    })
    .catch(function(error) {
        console.log('Error accessing the microphone:', error);
    });

function initialize(stream) {
    var audio_context = new AudioContext();
    var microphone = audio_context.createMediaStreamSource(stream);
    window.source = microphone; // Workaround for https://bugzilla.mozilla.org/show_bug.cgi?id=934512
    var script_processor = audio_context.createScriptProcessor(1024, 1, 1);

    script_processor.connect(audio_context.destination);
    microphone.connect(script_processor);

    var buffer = [];
    var sample_length_milliseconds = 100;
    var recording = true;

    window.capture_audio = function(event) {
        if (!recording) return;

        buffer = buffer.concat(Array.prototype.slice.call(event.inputBuffer.getChannelData(0)));

        if (buffer.length > sample_length_milliseconds * audio_context.sampleRate / 1000) {
            recording = false;

            correlation_worker.postMessage({
                "timeseries": buffer,
                "test_frequencies": test_frequencies,
                "sample_rate": audio_context.sampleRate
            });

            buffer = [];
            setTimeout(function() {
                recording = true;
            }, 250);
        }
    };

    script_processor.onaudioprocess = window.capture_audio;
}
</script>
</body>
</html>
