<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GTuner</title>
    <style>
        .needle {
            width: 2px;
            height: 80px;
            background-color: red;
            position: absolute;
            transform-origin: 50% 100%;
        }
    </style>
</head>
<body>
    <h1>GTuner</h1>
    <p>Click the button to start tuning:</p>
    <button id="startButton">Start Tuning</button>
    <div id="pitchDisplay"></div>
    <div class="needle"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Tone.js/13.2.4/Tone.js"></script>
    <script>
        const audioContext = new AudioContext();
        const tuna = new Tuna(audioContext);
        let mic, tuner, isTuning = false;
        const referenceTones = {
            E2: 82.41,
            A2: 110.00,
            D3: 146.83,
            G3: 196.00,
            B3: 246.94,
            highE4: 329.63
        };

        const startButton = document.getElementById('startButton');
        const pitchDisplay = document.getElementById('pitchDisplay');
        const needle = document.querySelector('.needle');

        startButton.addEventListener('click', () => {
            if (!isTuning) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function (stream) {
                        mic = audioContext.createMediaStreamSource(stream);

                        tuner = new tuna.PitchDetect();
                        mic.connect(tuner);

                        tuner.onNoteDetected = (note, frequency) => {
                            pitchDisplay.textContent = `Detected Pitch: ${note}`;

                            // Visual Feedback (Needle): Rotate the needle based on pitch accuracy
                            const targetFrequency = referenceTones[note];
                            const pitchDifference = frequency - targetFrequency;
                            const maxDifference = 10; // Adjust as needed for accuracy

                            // Limit the rotation angle to provide visual feedback
                            const rotation = Math.min(Math.max(pitchDifference / maxDifference, -1), 1) * 45; // 45 degrees max

                            // Apply rotation to the needle
                            needle.style.transform = `rotate(${rotation}deg)`;

                            // You can also add logic to give feedback on whether the pitch is in tune.
                        };

                        isTuning = true;
                        startButton.textContent = 'Stop Tuning';
                    })
                    .catch(function (error) {
                        console.error('Error accessing microphone:', error);
                    });
            } else {
                if (mic) {
                    mic.disconnect();
                }
                if (tuner) {
                    tuner.onNoteDetected = null;
                }
                pitchDisplay.textContent = 'Tuning stopped';
                needle.style.transform = 'rotate(0deg)'; // Reset the needle
                isTuning = false;
                startButton.textContent = 'Start Tuning';
            }
        });
    </script>
</body>
</html>
