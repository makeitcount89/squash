<!DOCTYPE html>
<html>
<head>
    <style>
       body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .indicator-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .indicator {
            width: 100px; /* Doubled the width */
            height: 100px; /* Doubled the height */
            border-radius: 50%;
            display: none;
        }

        .flat, .in-tune, .sharp {
            font-size: 2em; /* Doubled the font size */
        }

        .flat {
            background-color: red;
        }

        .in-tune {
            background-color: green;
        }

        .sharp {
            background-color: red;
        }

        .meter {
            width: 200px;
            height: 20px;
            background-color: blue;
            margin-top: 20px;
        }
    </style>
    <script>
        var notes = ["A", "E", "D", "G", "B", "E"];
        var targetFrequencies = [220.00, 329.63, 293.66, 392.00, 246.94, 329.63]; // A, E, D, G, B, E in Hz

        window.addEventListener("load", initialize);

        var correlation_worker = new Worker("correlation_worker.js");
        correlation_worker.addEventListener("message", interpret_correlation_result);

        function initialize() {
            var get_user_media = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
            get_user_media.call(navigator, { "audio": true }, use_stream, function() {});

            // The play-note button has been removed.
        }

        function use_stream(stream) {
            var audio_context = new AudioContext();
            var microphone = audio_context.createMediaStreamSource(stream);
            window.source = microphone;
            var script_processor = audio_context.createScriptProcessor(1024, 1, 1);

            script_processor.connect(audio_context.destination);
            microphone.connect(script_processor);

            var buffer = [];
            var sample_length_milliseconds = 100;
            var recording = true;

            window.capture_audio = function(event) {
                if (!recording)
                    return;

                buffer = buffer.concat(Array.prototype.slice.call(event.inputBuffer.getChannelData(0)));

                if (buffer.length > sample_length_milliseconds * audio_context.sampleRate / 1000) {
                    recording = false;

                    correlation_worker.postMessage({
                        "timeseries": buffer,
                        "targetFrequencies": targetFrequencies,
                        "sample_rate": audio_context.sampleRate
                    });

                    buffer = [];
                    setTimeout(function() { recording = true; }, 250);
                }
            };

            script_processor.onaudioprocess = window.capture_audio;
        }

        function interpret_correlation_result(event) {
            var timeseries = event.data.timeseries;
            var targetFrequencies = event.data.targetFrequencies;
            var frequency_amplitudes = event.data.frequency_amplitudes;

            var magnitudes = frequency_amplitudes.map(function(z) { return z[0] * z[0] + z[1] * z[1]; });

            var maximum_index = -1;
            var maximum_magnitude = 0;
            for (var i = 0; i < magnitudes.length; i++) {
                if (magnitudes[i] <= maximum_magnitude)
                    continue;

                maximum_index = i;
                maximum_magnitude = magnitudes[i];
            }

            var average = magnitudes.reduce(function(a, b) { return a + b; }, 0) / magnitudes.length;
            var confidence = maximum_magnitude / average;
            var confidence_threshold = 10;

            if (confidence > confidence_threshold) {
                var detectedFrequency = targetFrequencies[maximum_index];
                var closestNoteIndex = findClosestNoteIndex(detectedFrequency, targetFrequencies);
                var closestNote = notes[closestNoteIndex];

                document.getElementById("note-name").textContent = closestNote;
                document.getElementById("frequency").textContent = detectedFrequency.toFixed(2) + " Hz";

                var flatIndicator = document.getElementById("flat-indicator");
                var inTuneIndicator = document.getElementById("in-tune-indicator");
                var sharpIndicator = document.getElementById("sharp-indicator");

                flatIndicator.style.display = "none";
                inTuneIndicator.style.display = "none";
                sharpIndicator.style.display = "none";

                if (closestNoteIndex === 3) {
                    // The G note (3rd index in notes) is a bit sharp
                    sharpIndicator.style.display = "block";
                } else if (closestNoteIndex === 2) {
                    // The D note (2nd index in notes) is in tune
                    inTuneIndicator.style display = "block";
                } else {
                    // All other notes are a bit flat
                    flatIndicator.style.display = "block";
                }

                // Compare the detected frequency to the target frequency
                var meter = document.getElementById("meter");
                var difference = detectedFrequency - targetFrequencies[closestNoteIndex];
                meter.style.width = (50 + (difference * 10)) + "px"; // Adjust the scaling factor as needed
            }
        }

        function findClosestNoteIndex(detectedFrequency, targetFrequencies) {
            var closestIndex = 0;
            var closestDifference = Math.abs(detectedFrequency - targetFrequencies[0]);

            for (var i = 1; i < targetFrequencies.length; i++) {
                var difference = Math.abs(detectedFrequency - targetFrequencies[i]);
                if (difference < closestDifference) {
                    closestDifference = difference;
                    closestIndex = i;
                }
            }

            return closestIndex;
        }
    </script>
</head>
<body>

<h1 id="note-name" style="font-size: 6em;"></h1>
<p>
    <span style="font-size: 2em;">frequency (Hz):</span>
    <span id="frequency" style="font-size: 2em;"></span>
</p>
<div class="indicator-container">
    <div id="flat-indicator" class="indicator flat"></div>
    <div id "in-tune-indicator" class="indicator in-tune"></div>
    <div id="sharp-indicator" class="indicator sharp"></div>
</div>
<div id="meter" class="meter"></div>
</body>
</html>
