<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D to 3D Floor Plan</title>
    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babylonjs/5.6.3/babylon.max.js"></script>
</head>
<body>
    <input type="file" id="imageInput" accept="image/*" style="display: none;">
    <button onclick="uploadImage()">Upload Image</button>
    <button onclick="extractLines()">Extract Lines</button>
    <button onclick="render3D()">Render 3D</button>

    <label for="wallThickness">Wall Thickness:</label>
    <input type="number" id="wallThickness" value="0.1">

    <label for="wallHeight">Wall Height:</label>
    <input type="number" id="wallHeight" value="1">

    <canvas id="renderCanvas" width="800" height="600"></canvas>

    <script>
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true);
        var scene = new BABYLON.Scene(engine);
        var camera = new BABYLON.ArcRotateCamera("Camera", Math.PI / 2, Math.PI / 4, 4, BABYLON.Vector3.Zero(), scene);
        camera.attachControl(canvas, true);

        var lines;

        function uploadImage() {
            var input = document.getElementById("imageInput");
            input.click();

            input.onchange = function () {
                var file = input.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var img = new Image();
                        img.src = e.target.result;
                        img.onload = function () {
                            extractLinesFromImage(img);
                        };
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        function extractLines() {
            if (lines) {
                lines.forEach(line => line.dispose());
            }

            var wallThickness = parseFloat(document.getElementById("wallThickness").value);
            var wallHeight = parseFloat(document.getElementById("wallHeight").value);

            // Implement your line extraction logic here
            extractLinesFromImage(document.getElementById("inputImage"));
        }

        function render3D() {
            // Implement your 3D rendering logic here
            // This is a placeholder for illustration purposes
            // You may want to use the lines generated earlier to create walls
            console.log("Rendering 3D");
        }

        function onOpenCvReady() {
            document.getElementById('inputImage').onchange = function (e) {
                var reader = new FileReader();
                reader.onload = function (event) {
                    var img = cv.imread(new Uint8Array(event.target.result));
                    var gray = new cv.Mat();
                    cv.cvtColor(img, gray, cv.COLOR_RGBA2GRAY);
                    var edges = new cv.Mat();
                    cv.Canny(gray, edges, 50, 150, 3, false);
                    cv.imshow('outputCanvas', edges);
                    gray.delete();
                    edges.delete();
                };
                reader.readAsArrayBuffer(this.files[0]);
            };
        }

        engine.runRenderLoop(function () {
            scene.render();
        });

        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>
</body>
</html>
